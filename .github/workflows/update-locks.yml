name: Update Lockfiles

on:
  push:
    paths:
      - "pyproject.toml"
  workflow_dispatch: {}

permissions:
  contents: write
  pull-requests: write

jobs:
  update-locks:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install uv
        run: |
          curl -Ls https://astral.sh/uv/install.sh | sh
          echo "${HOME}/.local/bin" >> $GITHUB_PATH

      - name: Compile locked requirements (runtime)
        run: uv pip compile pyproject.toml -o requirements.txt

      - name: Compile locked requirements (dev)
        run: uv pip compile --extra dev pyproject.toml -o requirements-dev.txt

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet requirements.txt requirements-dev.txt; then
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "No changes detected in requirements files"
          else
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "Changes detected in requirements files"
          fi

      # Prefer a personal access token if provided, since some repos block GITHUB_TOKEN PRs
      - name: Create Pull Request (using PAT if provided)
        if: steps.changes.outputs.changes == 'true' && secrets.ACTIONS_PR_TOKEN != ''
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.ACTIONS_PR_TOKEN }}
          commit-message: "chore(lock): update requirements via uv compile"
          title: "chore(lock): update requirements"
          body: |
            Automated lockfile refresh from pyproject.toml.

            - Updated requirements.txt and requirements-dev.txt using `uv pip compile`.
          branch: chore/update-locks
          delete-branch: true
          labels: dependencies, automated pr
          add-paths: |
            requirements.txt
            requirements-dev.txt

      - name: Create Pull Request (best-effort with GITHUB_TOKEN)
        if: steps.changes.outputs.changes == 'true' && (secrets.ACTIONS_PR_TOKEN == '')
        id: cpr_fallback
        continue-on-error: true
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "chore(lock): update requirements via uv compile"
          title: "chore(lock): update requirements"
          body: |
            Automated lockfile refresh from pyproject.toml.

            - Updated requirements.txt and requirements-dev.txt using `uv pip compile`.
          branch: chore/update-locks
          delete-branch: true
          labels: dependencies, automated pr
          add-paths: |
            requirements.txt
            requirements-dev.txt

      - name: Note PR permission restriction
        if: steps.changes.outputs.changes == 'true' && (secrets.ACTIONS_PR_TOKEN == '')
        run: |
          echo "::warning::Repository blocks GitHub Actions from creating PRs."
          echo "Set a repo/org secret 'ACTIONS_PR_TOKEN' with 'contents' and 'pull_requests' write permissions (fine-grained PAT), or enable the setting to allow Actions to create PRs."

      - name: Enable auto-merge for lockfile PR
        if: steps.changes.outputs.changes == 'true' && steps.cpr.outputs.pull-request-number != ''
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash

      - name: No changes detected
        if: steps.changes.outputs.changes == 'false'
        run: echo "Requirements files are up to date, no PR needed"
