# Prometheus alerting rules for Bite-Size Reader
#
# These rules define conditions that trigger alerts:
# - High error rate
# - Circuit breaker open
# - High latency
# - Database issues

groups:
  - name: bsr_availability
    rules:
      # High error rate alert
      - alert: BSRHighErrorRate
        expr: |
          (
            sum(rate(bsr_requests_total{status="error"}[5m]))
            /
            sum(rate(bsr_requests_total[5m]))
          ) > 0.1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} over the last 5 minutes"

      # Critical error rate
      - alert: BSRCriticalErrorRate
        expr: |
          (
            sum(rate(bsr_requests_total{status="error"}[5m]))
            /
            sum(rate(bsr_requests_total[5m]))
          ) > 0.25
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Critical error rate detected"
          description: "Error rate is {{ $value | humanizePercentage }} - immediate attention required"

  - name: bsr_circuit_breakers
    rules:
      # Circuit breaker open
      - alert: BSRCircuitBreakerOpen
        expr: bsr_circuit_breaker_state > 1
        for: 1m
        labels:
          severity: warning
        annotations:
          summary: "Circuit breaker is open for {{ $labels.service }}"
          description: "Circuit breaker for {{ $labels.service }} has been open for more than 1 minute"

      # Circuit breaker stuck open
      - alert: BSRCircuitBreakerStuckOpen
        expr: bsr_circuit_breaker_state > 1
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "Circuit breaker stuck open for {{ $labels.service }}"
          description: "Circuit breaker for {{ $labels.service }} has been open for more than 5 minutes - manual intervention may be required"

  - name: bsr_latency
    rules:
      # High request latency
      - alert: BSRHighLatency
        expr: |
          histogram_quantile(0.99,
            sum(rate(bsr_request_latency_seconds_bucket[5m])) by (le, type)
          ) > 120
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High request latency for {{ $labels.type }}"
          description: "p99 latency is {{ $value | humanizeDuration }} for {{ $labels.type }} requests"

      # High Firecrawl latency
      - alert: BSRFirecrawlHighLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(bsr_firecrawl_latency_seconds_bucket[5m])) by (le, endpoint)
          ) > 30
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High Firecrawl latency for {{ $labels.endpoint }}"
          description: "p95 Firecrawl latency is {{ $value | humanizeDuration }}"

      # High OpenRouter latency
      - alert: BSROpenRouterHighLatency
        expr: |
          histogram_quantile(0.95,
            sum(rate(bsr_openrouter_latency_seconds_bucket[5m])) by (le, model)
          ) > 60
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High OpenRouter latency for {{ $labels.model }}"
          description: "p95 OpenRouter latency is {{ $value | humanizeDuration }}"

  - name: bsr_database
    rules:
      # Slow database queries
      - alert: BSRSlowDatabaseQueries
        expr: |
          histogram_quantile(0.95,
            sum(rate(bsr_db_query_latency_seconds_bucket[5m])) by (le, operation)
          ) > 1
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "Slow database queries detected"
          description: "p95 database query latency is {{ $value | humanizeDuration }} for {{ $labels.operation }}"

  - name: bsr_external_services
    rules:
      # Firecrawl high error rate
      - alert: BSRFirecrawlHighErrors
        expr: |
          (
            sum(rate(bsr_firecrawl_requests_total{status="error"}[5m]))
            /
            sum(rate(bsr_firecrawl_requests_total[5m]))
          ) > 0.2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High Firecrawl error rate"
          description: "Firecrawl error rate is {{ $value | humanizePercentage }}"

      # No Firecrawl requests (service may be down)
      - alert: BSRFirecrawlNoRequests
        expr: |
          sum(rate(bsr_firecrawl_requests_total[10m])) == 0
          and
          sum(rate(bsr_requests_total{type="url"}[10m])) > 0
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "No Firecrawl requests despite URL processing"
          description: "URL requests are being processed but no Firecrawl API calls - check circuit breaker or caching"

  - name: bsr_costs
    rules:
      # High OpenRouter spending
      - alert: BSRHighOpenRouterSpending
        expr: |
          increase(bsr_openrouter_cost_usd_total[1h]) > 10
        for: 0m
        labels:
          severity: warning
        annotations:
          summary: "High OpenRouter spending"
          description: "OpenRouter costs in the last hour: ${{ $value | printf \"%.2f\" }}"

      # Very high daily spending
      - alert: BSRVeryHighDailySpending
        expr: |
          increase(bsr_openrouter_cost_usd_total[24h]) > 100
        for: 0m
        labels:
          severity: critical
        annotations:
          summary: "Very high daily OpenRouter spending"
          description: "OpenRouter costs in the last 24 hours: ${{ $value | printf \"%.2f\" }}"
